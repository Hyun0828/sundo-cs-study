## 3. 네트워크 계층 - IP

---

### 01. IP의 목적과 특징

- IP의 목적
    1. **주소 지정** - 네트워크 간의 통신 과정에서 호스트를 특정하는 것
        
        ![image](https://github.com/user-attachments/assets/7a50abd5-8096-45d4-a478-104d62424835)
        
        위는 IPv4의 패킷 헤더와 페이로드를 나타냄
        
        - 송신지 IP 주소(Source IP Address)와 수신지 IP 주소(Destination IP Address)
            - 송수신지를 식별할 수 있는 IP 주소가 명시됨
            - 하나의 IP 주소는 총 4바이트(8비트 * 4개)로 구성됨
                
                → 0~255 사이의 10진수 4개(ex. 192.168.0.1)로 표기함. 여기서 10진수(ex. ‘192’, ‘168’, ‘0’, ‘1’)를 **옥텟**이라고 함
                
            - MAC 주소 : 택배 배송 과정의 수신인과 발신인, IP 주소는 수신 주소와 발신 주소에 빗댈 수 있음
                - 배송 과정에서 수신인과 발신인 정보보다 주소를 우선적으로 활용하듯, 패킷의 송수신에서도 MAC 주소보다 IP 주소를 우선적으로 활용함
        - **라우터(router)**
            - IP 주소를 바탕으로 목적지까지 IP 패킷을 전달하는 네트워크 장비
            - **라우팅(routing)** - IP 패킷을 전달할 최적의 경로를 결정하고 해당 경로로 패킷을 보내는 과정
        
        > IPv4와 IPv6
        IPv4의 주소는 총 32비트로 표현됨. 할당 가능한 주소는 $2^{32}$개, 약 43억개로 부족함
        그래서 나온게 IPv6로, 16바이트(128비트)로 주소를 표현함. 이는 $2^{128}$개임.
        IPv6는 8개의 16진수로 표기함. (ex. 2001:0230:abcd:ffff:0000:0000:ffff:1111)
        > 
    2. **단편화** - 데이터를 여러 IP 패킷으로 올바르게 쪼개어 보내는 것
        - **MTU** (Maximum Transmission Unit) - 최대 전송 단위
            - 전송하고자 하는 IP 패킷의 크기가 MTU보다 클 경우 패킷을 MTU보다 작게 쪼개서 전송함
            쪼개져서 전송된 패킷들은 수신지에서 재조합됨
            - 일반적인 MTU의 크기는 1500바이트
            - MTU는 프레임을 통해 주고받을 수 있는 최대 페이로드의 크기라고 보아도 무방함
        - IP 패킷 헤더에서 단편화와 관련된 필드는 식별자(identification), 플래그(Flags), 단편화 오프셋(Fragment Offset)이 있음
            - 식별자(identification) - 특정 패킷이 어떤 데이터에서 쪼개진 패킷인지 식별하기 위함. 같은 데이터에서 쪼개진 패킷들은 같은 식별자를 공유함
            - 플래그(Flags) - 3비트로 구성된 필드. 2, 3번째 비트는 각각 DF와 MF라는 이름이 있음
                1. 첫 비트 : 항상 0, 오늘날 사용되지 않음
                2. DF 비트 : Don’t Fragment. 단편화를 수행하지 말라
                3. MF 비트 : More Fragment. 단편화된 패킷이 더 있다
            - 단편화 오프셋(Fragment Offset) - 특정 패킷이 초기 데이터에서 얼마나 떨어져 있는지가 명시된 필드. 목적지에서 패킷을 올바른 순서로 재조립 하기 위함
- IP의 특징
    - 신뢰할 수 없는 통신 + 비연결형 통신
    1. **신뢰할 수 없는 프로토콜**
        - 패킷이 수신지까지 제대로 전송되었다고 보장하지 않는 프로토콜
        → 패킷이 유실되거나 순서대로 도착하지 않더라도 조치를 취하지 않음
        - 이러한 송수신은 신뢰할 수 없는 통신, 신뢰성이 낮은 통신, 최선형 전달(best effort)라고 부름
    2. **비연결형 프로토콜**
        - 패킷을 주고받기 전에 사전 연결 과정을 거치지 않음
        → 상대 호스트의 수신 가능 여부는 고려하지 않고, 그냥 전송함
        - ↔ **TCP** - 연결을 맺는 프로토콜(다음 절에 나옴)
        
        > IP 단편화 피하기 - 경로 MTU 발견
        사실 오늘날의 네트워크 환경에선 IP 단편화가 잘 발생하지 않음
        네트워크 성능의 발전도 있지만, 되도록 단편화를 발생시키지 않는게 좋음
        단편화가 많아지면 헤더도 많아지고 패킷 재조립에서 성능 저하로 이어짐
        IP 단편화를 피하려면 패킷을 주고 받는 경로에 존재하는 모든 호스트의 ‘처리 가능한 MTU 크기’를 고려하여 ‘IP 단편화 없이 주고 받을 수 있는 최대 크기’만큼만 전송해야 함. 이 크기를 **경로 MTU(Path MTU)**라고 함
        이렇게 주고 받을 수 있는 경로 MTU를 구하고 해당 크기만큼만 송수신하여 IP 단편화를 회피하는 기술을 경로 **MTU 발견(Path MTU discovery)**라고 함
        > 

### 02. IP 주소의 구조

IP 주소는 크게 **네트워크 주소**와 **호스트 주소**로 이루어져 있음

네트워크 주소 : 네트워크 ID, 네트워크 식별자 등으로 불리며, 호스트가 속한 네트워크를 특정하기 위해 사용됨

호스트 주소 : 호스트 ID, 호스트 식별자 등으로 불리며, 네트워크에 속한 호스트를 특정하기 위해 사용됨

- 하나의 IP 주소에서 네트워크 주소를 표현하는 크기와 호스트를 표현하는 크기가 유동적일 수 있음
- **클래스풀 주소 체계**
    - 호스트 주소의 공간을 너무 크게 할당하면 다수의 IP 주소가 낭비될 수 있고, 적게 할당하면 호스트가 사용할 IP 주소가 부족할 수 있음
    - **클래스**
        - 네트워크의 크기에 따라 유형별로 IP 주소를 분류하는 기준
        - A ~ E 까지 총 5개의 종류가 있음. 이 중 D와 E 클래스는 멀티캐스트를 위한 클래스로, 특수한 목적을 위해 예약된 클래스이기 때문에 실질적으로 사용되는 클래스는 A, B, C임.
        - 이러한 클래스를 바탕으로 IP 주소를 관리하는 주소 체계를 **클래스풀 주소 체계**라고 함
            
            ![image](https://github.com/user-attachments/assets/5ed9ee2d-243d-4661-8c30-21bd4f4da4fa)
            
            A 클래스는 비트 ‘0’으로 시작해 1옥텟의 네트워크 주소, 3옥텟의 호스트 주소로 구성됨
            → 0.0.0.0 ~ 127.255.255.255
            
            B 클래스는 비트 ‘10’으로 시작해 2옥텟의 네트워크 주소, 2옥텟의 호스트 주소로 구성됨
            → 128.0.0.0 ~ 191.255.255.255
            
            C 클래스는 비트 ‘110’으로 시작해 3옥텟의 네트워크 주소, 1옥텟의 호스트 주소로 구성됨
            → 192.0.0.0 ~ 223.255.255.255
            
            > 호스트의 주소 공간을 모두 사용할 수 있는 것은 아님
            호스트 주소가 전부 0인 주소 : **해당 네트워크 자체를 의미하는 주소**
            호스트 주소가 전부 1인 주소 : **브로드캐스트를 위한 주소**
            예약된 주소 : 특수한 목적을 위한 주소
            - 0.0.0.0 ~ 0.255.255.255 : ‘이 네트워크의 이 호스트(This host on this network)’ 지칭에 사용. 대표적으로 ‘0.0.0.0’는 IP 주소를 할당받기 전에 임시로 사용하거나 마땅히 자신을 지칭할 IP 주소가 없을 때 사용함
            - 127.0.0.0 ~ 127.255.255.255 : **루프백 주소**. 주기 자신을 가리키는 주소. 대표적으로 ‘127.0.0.1’은 **로컬호스트(localhost)**로, 전송된 패킷이 자기 자신에게 되돌아옴
            - 사설 네트워크 주소로 사용 되는 주소도 있음
            > 
- **서브넷 마스크(subnet nask)**
    - 고정된 크기의 네트워크 주소만 사용하면 호스트 주소가 낭비될 수 있음
    - 클래스리스 주소 체계 - 클래스를 이용하지 않고 네트워크와 호스트를 구분하는 방식
    - **서브넷 마스크** - IP 주소상에서 네트워크 주소를 1로 표기하고 호스트 주소를 0으로 표기한 비트열
    - **서브네트워크(서브넷)** - IP 주소에서 네트워크 주소로 구분할 수 있는 네트워크의 부분집합
    - **서브네팅** - 서브넷 마스크를 이용하여 원하는 크기로 클래스를 더 잘게 쪼개어 사용하는 것
        - 서브넷 마스크와 IP 주소 간에 비트 AND 연산을 수행하면 IP 주소 내의 네트워크 주소를 알아낼 수 있음
        ex. IP주소 : ‘192.168.56.11’, 서브넷 마스크 : ‘255.255.255.0’
            
            ![image](https://github.com/user-attachments/assets/4a152c99-fe1d-4740-bd64-018ced1055a4)

    
    > CIDR 표기법 (Classless Inter-Domain Routing notation)
    ’IP 주소/서브넷 마스크상의 1의 개수’ 형식으로 표기하는 방법
     IP주소 : ‘192.168.56.11’, 서브넷 마스크 : ‘255.255.255.0’
    → ‘192.168.56.11/24’
    > 

### 03. 공인 IP 주소와 사설 IP 주소

호스트의 IP 주소는 네트워크 설정이나 명령어, 온라인 검색으로 확인할 수 있음

전자의 경우 윈도우에선 ‘ipconfig/all’, 맥OS, 리눅스에선 ‘ifconfig’로 확인 가능

명령어로 확인한 주소와 온라인 검색으로 확인한 주소는 다름

IP주소엔 고유한 IP 주소(공인 IP 주소)도 있고, 고유하지 않은 IP 주소(사설 IP 주소)도 있음

- 공인 IP 주소
    - 전 세계에서 고유한 IP 주소
    - 인터넷을 비롯한 네트워크 간 통신에서 사용되는 IP 주소. 온라인 검색으로 확인한 IP 주소가 공인 IP 주소임
    - 공인 IP 주소는 ISP 나 공인 IP 주소 할당 기관을 통해 할당받을 수 있음
- 사설 IP 주소
    - 사설 네트워크에서 사용하기 위한 IP 주소
    - 일반적으로 라우터(공유기)를 통해 할당되기 때문에 라우터(공유기)를 중심으로 구성된 LAN 대부분은 사설 네트워크에 해당됨
    - IP 주소 공간 중에서 사설 IP 주소로 사용하도록 특별히 예약된 IP 주소 공간이 있음
    10.0.0.0/8 (10.0.0.0 ~ 10.255.255.255)
    172.16.0.0/12 (172.16.0.0 ~ 172.31.255.255)
    192.168.0.0/16 (192.168.0.0 ~ 192.168.255.255)

### 04. IP 주소의 할당

호스트에 IP 주소를 할당하는 방법

- 정적 할당
    - 수작업
    - 정적 IP 주소를 부여하고자 하는 IP 주소와 서브넷 마스크, 게이트웨이(라우터) 주소, DNS 주소 등이 필요함
        - **게이트웨이**
            - 일반적으로 서로 다른 네트워크를 연결하는 하드웨어적/소프트웨어적 수단을 의미
            - **기본 게이트웨이**
                - 호스트가 속한 네트워크의 외부로 나가기 위한 첫 기본 경로
                - 네트워크 외부와 연결된 라우터의 주소를 의미하는 경우가 많음
                - IP 할당의 맥락에서 게이트웨이 라는 용어는 기본 게이트웨이를 의미함
        - DNS 주소
            - 호스트가 도메인 네임을 토대로 IP 주소를 알아내기 위해 질의하는 서버의 주소
            - 도메인 네임 - IP 주소에 대응되는 기억할 수 있는 문자열(ex. ‘google.com’, ‘naver.com’)
            - 호스트가 도메인 네임에 대응되는 IP 주소를 알아내기 위해 해당 데이터를 저장하는 서버에 질의를 해야햄. 이 서버가 DNS 서버
- 동적 할당
    - DHCP (Dynamic Host Configuration Protocol)
        - 자동으로 IP를 부여하기 위해 사용되는 프로토콜
        - IP 주소를 동적으로 할당받고자 하는 호스트는 DHCP 서버와 메시지를 주고 받으며 동적 IP 주소를 할당받을 수 있음.
            - DHCP서버는 호스트에 할당 가능한 주소 목록을 관리하다가, IP 주소를 할당해주는 호스트
            - 일반적으로 라우터(공유기)가 DHCP 서버 역할을 수행함
        - 동적 IP 주소에는 사용 가능한 기간이 정해져 있음
        - 동적 IP 주소는 할당받을 때마다 다른 주소를 받을 수 있음
            - IP 주소의 임대 기간을 연장할 수도 있음. 이를 임대 갱신 이라고 함. 기본적으로 임대 갱신은 자동으로 두 차례가 수행되고, 두 번의 임대 갱신이 모두 실패하면 그때 IP 주소는 DHCP 서버로 반납됨

### 05. IP 전송 특징의 보완: ICMP

IP는 신뢰할 수 없는 프로토콜이자, 비연결형 프로토콜이지만 이 특징이 꼭 나쁜 것은 아님

신뢰성 높은 송수신을 하기 위해선 오류 제어(유실된 패킷, 순서가 어긋난 패킷 등이 있는지 점검)를 수행해야 함

연결형 송수신을 하기 위해서 연결 수립과 연결 관리를 해야함

이는 많은 시간과 대역폭, 부하가 필요하기에 성능상 불리함

→ IP의 특징이 반드시 극복해야 할 문제가 아님

하지만 보완해야할 필요가 있을 때가 있음. 이를 위한 방법은 다음과 같음

1. 상위 계층의 프로토콜인 TCP를 이용
2. 네트워크 계층의 프로토콜인 **ICMP(Internet Control Message Protocol)**를 이용
- ICMP
    - IP 패킷의 전송 과정에 대한 피드백 메시지(ICMP 메시지)를 얻기 위해 사용하는 프로토콜
    
    > ICMP가 IP의 신뢰성을 완전히 보장하지는 않음
    > 
    - ICMP 메시지
        1. 전송과정에서 발생한 오류 보고
        2. 네트워크에 대한 진단 정보(네트워크상의 정보 제공)
        - 자주 보이는 ICMP 메시지의 종류
            
            
            | 유형 | 메시지 |
            | --- | --- |
            | 오류 보고 | - 네트워크 도달 불가 (Destination network unreachable)<br>- 호스트 도달 불가 (Destination host unreachable)<br>- 프로토콜 도달 불가, 수신지에서 특정 프로토콜을 사용할 수 없음 (Destination protocol unreachable)<br>- 포트 도달 불가 (Destination port unreachable)<br>- 단편화가 필요하지만 DF가 1로 설정되어 단편화할 수 없음 (Fragmentation required, and DF flag set)<br>- TTL 만료 (TTL expired in transit) |
            | 네트워크 상의 정보 제공 | - Echo 요청 (Echo request)<br>- Echo 응답 (Echo reply) |
            - 네트워크 도달 불가
                - 네트워크 장비가 패킷을 전달 받았는데 어떤 네트워크로 전송해야 할지 알 수 없을 경우
            - 단편화가 필요하지만 DF가 1로 설정되어 단편화할 수 없음
                - 너무 큰 패킷을 받았는데 DF가 1로 설정되어 단편화가 불가능한 경우
            - TTL 만료(시간 초과)
                - 패킷은 라우터를 하나 거칠 때마다 TTL이 1씩 감소하게 되는데, TTL 필드가 0이 되면 패킷은 폐기되고 시간초과 ICMP 메시지가 전송됨
                    - TTL - 패킷의 수명
                    - 홉(hop) - 패킷이 호스트 or 라우터에 한 번 전달되는 것
    - ICMP를 기반으로 구현된 대표적인 명령어
        - traceroute(윈도우의 경우 tracert) - 네트워크 상의 경로를 확인하는 명령어
        - ping - 네트워크 상태를 점검하기 위해 패킷을 송신하는 명령어

### 06. IP 주소와 MAC 주소의 대응: ARP

- 앞에서 MAC 주소보다 IP 주소를 우선적으로 활용한다고 함
상대 호스트의 IP 주소는 알지만 MAC 주소는 모르는 상황이 있을 수 있음. 이 때 사용되는 프로토콜
- **ARP(Address Resolution Protocol)**
    - **ARP 요청 메시지**와 **ARP 응답 메시지**를 통해 이루어짐
    - ARP 요청 메시지
        - 브로드캐시트 메시지
        - 알고 싶은 MAC 주소에 대응되는 IP 주소가 포함되어 있음
        - ‘이 IP 주소를 가진 호스트와 통신하고 싶은데, 이 호스트의 MAC 주소가 무엇인가요?’ 라고 소리치는 것과 같음
        - 네트워크 내 모든 호스트들은 해당 IP 주소가 자신의 주소일 경우에만 ARP 응답 메시지를 보냄
    - ARP 응답 메시지
        - 호스트의 MAC 주소가 포함되어 있음
- 호스트 입장에서 ARP를 통해 알게된 <IP 주소, MAC 주소> 쌍은 **ARP 테이블**에 저장함
- 일정 시간이 지나면 삭제되고, 임의로 삭제 가능
